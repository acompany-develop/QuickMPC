version: "3.3"
services:
  dev_cc1:
    tty: true
    container_name: computation_container1
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-dev
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-dev
    volumes:
      - type: bind
        source: ../config/computation_container/compute1
        target: /QuickMPC/config
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    env_file:
      - ../config/computation_container/compute1/.env
      - ../config/computation_container/jwt/client.sample.env
    networks:
      shared-network:
        ipv4_address: 10.0.1.20
    depends_on:
      dev_bts:
        condition: service_healthy
      dev_cc_envoy1:
        condition: service_started
    command: ["/bin/bash", "-c", "printenv && ./computation_container"]
    healthcheck:
      test: [
          "CMD-SHELL",
          "/bin/grpc_health_probe -addr=computation_container1:50010 &&
          /bin/grpc_health_probe -addr=computation_container1:51020
          ",
        ]
      interval: 3s
      timeout: 5s
      start_period: 5s

  dev_cc_envoy1:
    container_name: compute_envoy_container1
    tty: true # 起動しっぱなし
    image: envoyproxy/envoy:v1.17.1
    volumes:
      - type: bind
        source: ../config/computation_container/compute1/envoy.yaml
        target: /etc/envoy/envoy.yaml
    expose:
      - "50020"
      - "51020"
    networks:
      shared-network:
        ipv4_address: 10.0.1.21
    command: ["/bin/sh", "-c", "/usr/local/bin/envoy -c /etc/envoy/envoy.yaml"]

  dev_cc2:
    tty: true # docker run -t
    container_name: computation_container2
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-dev
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-dev
    volumes:
      - type: bind
        source: ../config/computation_container/compute2
        target: /QuickMPC/config
      - type: volume
        source: sharedb2
        target: /db/share
      - type: volume
        source: resultdb2
        target: /db/result
    env_file:
      - ../config/computation_container/compute2/.env
      - ../config/computation_container/jwt/client.sample.env
    depends_on:
      dev_cc_envoy2:
        condition: service_started
    networks:
      shared-network:
        ipv4_address: 10.0.2.20
    command: ["/bin/bash", "-c", "printenv && ./computation_container"]
    healthcheck:
      test: [
          "CMD-SHELL",
          "/bin/grpc_health_probe -addr=computation_container2:50010 &&
          /bin/grpc_health_probe -addr=computation_container2:51020
          ",
        ]
      interval: 3s
      timeout: 5s
      start_period: 5s

  dev_cc_envoy2:
    container_name: compute_envoy_container2
    tty: true # 起動しっぱなし
    image: envoyproxy/envoy:v1.17.1
    volumes:
      - type: bind
        source: ../config/computation_container/compute2/envoy.yaml
        target: /etc/envoy/envoy.yaml
    expose:
      - "50020"
      - "51020"
    networks:
      shared-network:
        ipv4_address: 10.0.2.21
    command: ["/bin/sh", "-c", "/usr/local/bin/envoy -c /etc/envoy/envoy.yaml"]

  dev_cc3:
    tty: true
    container_name: computation_container3
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-dev
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-dev
    volumes:
      - type: bind
        source: ../config/computation_container/compute3
        target: /QuickMPC/config
      - type: volume
        source: sharedb3
        target: /db/share
      - type: volume
        source: resultdb3
        target: /db/result
    env_file:
      - ../config/computation_container/compute3/.env
      - ../config/computation_container/jwt/client.sample.env
    depends_on:
      dev_cc_envoy3:
        condition: service_started
    networks:
      shared-network:
        ipv4_address: 10.0.3.20
    command: ["/bin/bash", "-c", "printenv && ./computation_container"]
    healthcheck:
      test: [
          "CMD-SHELL",
          "/bin/grpc_health_probe -addr=computation_container3:50010 &&
          /bin/grpc_health_probe -addr=computation_container3:51020
          ",
        ]
      interval: 3s
      timeout: 5s
      start_period: 5s

  dev_cc_envoy3:
    container_name: compute_envoy_container3
    tty: true # 起動しっぱなし
    image: envoyproxy/envoy:v1.17.1
    volumes:
      - type: bind
        source: ../config/computation_container/compute3/envoy.yaml
        target: /etc/envoy/envoy.yaml
    expose:
      - "50020"
      - "51020"
    networks:
      shared-network:
        ipv4_address: 10.0.3.21
    command: ["/bin/sh", "-c", "/usr/local/bin/envoy -c /etc/envoy/envoy.yaml"]

  # dev_bts_envoy:
  #   tty: true # 起動しっぱなし
  #   image: envoyproxy/envoy:v1.17.1
  #   volumes:
  #     - type: bind
  #       source: ../config/envoy.yaml
  #       target: /etc/envoy/envoy.yaml
  #   expose:
  #     - "9901"
  #   ports:
  #     - "0.0.0.0:51020:51020"
  #   networks:
  #     shared-network:
  #       ipv4_address: 10.0.1.21
  #   command: ["/bin/sh", "-c", "/usr/local/bin/envoy -c /etc/envoy/envoy.yaml"]

  dev_bts:
    container_name: beaver_triple_service
    image: ghcr.io/acompany-develop/quickmpc-bts:test-bts-dev
    build:
      context: ../
      dockerfile: packages/server/beaver_triple_service/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-bts:test-bts-dev
    volumes:
      - type: bind
        source: ../config/beaver_triple_service
        target: /QuickMPC/config
    env_file:
      - ../config/beaver_triple_service/.env
      - ../config/beaver_triple_service/server.sample.env
    ports:
      - "0.0.0.0:60020:50020"
    networks:
      shared-network:
        aliases:
          - beaver_triple_service
        ipv4_address: 10.0.1.40
    command: ["/bin/bash", "-c", "./beaver_triple_service"]
    healthcheck:
      test: [
          "CMD-SHELL",
          '/bin/grpc_health_probe
          -addr=beaver_triple_service:50020
          -rpc-header=authorization:"bearer $$BTS_TOKEN"',
        ]
      interval: 3s
      timeout: 5s
      start_period: 5s

  dev_mc1:
    container_name: manage_container1
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    volumes:
      - type: bind
        source: ../config/manage_container/manage1
        target: /QuickMPC/config
      # 開発環境のフォーマッタを統一
      - type: bind
        source: ../.vscode
        target: /QuickMPC/.vscode
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    env_file:
      - ../config/manage_container/manage1/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.1.10
    command: ["/bin/bash", "-c", "printenv && ./manage_container"]
    healthcheck:
      test: [
          "CMD-SHELL",
          "/bin/grpc_health_probe -addr=manage_container1:50011 &&
          /bin/grpc_health_probe -addr=manage_container1:51011
          ",
        ]
      interval: 3s
      timeout: 5s
      start_period: 5s
    depends_on:
      dev_mc_envoy1:
        condition: service_started
      dev_cc1:
        condition: service_started

  dev_mc_envoy1:
    container_name: manage_envoy_container1
    tty: true # 起動しっぱなし
    image: envoyproxy/envoy:v1.17.1
    volumes:
      - type: bind
        source: ../config/manage_container/manage1/envoy.yaml
        target: /etc/envoy/envoy.yaml
    expose:
      - "15000"
      - "50010"
    ports:
      - "0.0.0.0:50001:50000"
    networks:
      shared-network:
        ipv4_address: 10.0.1.11
    command: ["/bin/sh", "-c", "/usr/local/bin/envoy -c /etc/envoy/envoy.yaml"]

  dev_mc2:
    container_name: manage_container2
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    volumes:
      - type: bind
        source: ../config/manage_container/manage2
        target: /QuickMPC/config
      - type: volume
        source: sharedb2
        target: /db/share
      - type: volume
        source: resultdb2
        target: /db/result
    env_file:
      - ../config/manage_container/manage2/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.2.10
    command: ["/bin/bash", "-c", "printenv && ./manage_container"]
    healthcheck:
      test: [
          "CMD-SHELL",
          "/bin/grpc_health_probe -addr=manage_container2:50011 &&
          /bin/grpc_health_probe -addr=manage_container2:51011
          ",
        ]
      interval: 3s
      timeout: 5s
      start_period: 5s
    depends_on:
      dev_mc_envoy2:
        condition: service_started
      dev_cc2:
        condition: service_started

  dev_mc_envoy2:
    container_name: manage_envoy_container2
    tty: true # 起動しっぱなし
    image: envoyproxy/envoy:v1.17.1
    volumes:
      - type: bind
        source: ../config/manage_container/manage2/envoy.yaml
        target: /etc/envoy/envoy.yaml
    expose:
      - "15000"
      - "50010"
    ports:
      - "0.0.0.0:50002:50000"
    networks:
      shared-network:
        ipv4_address: 10.0.2.11
    command: ["/bin/sh", "-c", "/usr/local/bin/envoy -c /etc/envoy/envoy.yaml"]

  dev_mc3:
    container_name: manage_container3
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    volumes:
      - type: bind
        source: ../config/manage_container/manage3
        target: /QuickMPC/config
      - type: volume
        source: sharedb3
        target: /db/share
      - type: volume
        source: resultdb3
        target: /db/result
    env_file:
      - ../config/manage_container/manage3/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.3.10
    command: ["/bin/bash", "-c", "printenv && ./manage_container"]
    healthcheck:
      test: [
          "CMD-SHELL",
          "/bin/grpc_health_probe -addr=manage_container3:50011 &&
          /bin/grpc_health_probe -addr=manage_container3:51011
          ",
        ]
      interval: 3s
      timeout: 5s
      start_period: 5s
    depends_on:
      dev_mc_envoy3:
        condition: service_started
      dev_cc3:
        condition: service_started

  dev_mc_envoy3:
    container_name: manage_envoy_container3
    tty: true # 起動しっぱなし
    image: envoyproxy/envoy:v1.17.1
    volumes:
      - type: bind
        source: ../config/manage_container/manage3/envoy.yaml
        target: /etc/envoy/envoy.yaml
    expose:
      - "15000"
      - "50010"
    ports:
      - "0.0.0.0:50003:50000"
    networks:
      shared-network:
        ipv4_address: 10.0.3.11
    command: ["/bin/sh", "-c", "/usr/local/bin/envoy -c /etc/envoy/envoy.yaml"]

  small_cc:
    container_name: computation_container1
    tty: true # 起動しっぱなし
    volumes:
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-small
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      # temporarily change build stage from `small` to `small_tmp` because it takes long time.
      # TODO(#36): improve performance
      target: small_tmp
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-small

  small_mc:
    container_name: manage_container1
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-small
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: small
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-small
    volumes:
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    env_file:
      - ../config/manage_container/manage1/.env

  small_bts:
    container_name: beaver_triple_service
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-bts:test-bts-small
    build:
      context: ../
      dockerfile: packages/server/beaver_triple_service/Dockerfile
      target: small
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-bts:test-bts-small
    volumes:
      - type: bind
        source: ../config/beaver_triple_service
        target: /QuickMPC/config
    env_file:
      - ../config/beaver_triple_service/.env
      - ../config/beaver_triple_service/server.sample.env
    expose:
      - "50020"

  medium_cc1:
    container_name: computation_container1
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    volumes:
      - type: bind
        source: ../config/computation_container/compute1
        target: /QuickMPC/config
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    env_file:
      - ../config/computation_container/compute1/.env
      - ../config/computation_container/jwt/client.sample.env
    networks:
      shared-network:
        ipv4_address: 10.0.1.20
    depends_on:
      dev_bts:
        condition: service_healthy
      dev_cc_envoy1:
        condition: service_started
    command: ["/bin/bash", "-c", "printenv && ./computation_container_test"]

  medium_cc2:
    container_name: computation_container2
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    volumes:
      - type: bind
        source: ../config/computation_container/compute2
        target: /QuickMPC/config
      - type: volume
        source: sharedb2
        target: /db/share
      - type: volume
        source: resultdb2
        target: /db/result
    env_file:
      - ../config/computation_container/compute2/.env
      - ../config/computation_container/jwt/client.sample.env
    networks:
      shared-network:
        ipv4_address: 10.0.2.20
    depends_on:
      dev_bts:
        condition: service_healthy
    depends_on:
      dev_cc_envoy2:
        condition: service_started
    command: ["/bin/bash", "-c", "printenv && ./computation_container_test"]

  medium_cc3:
    tty: true # docker run -t
    container_name: computation_container3
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    volumes:
      - type: bind
        source: ../config/computation_container/compute3
        target: /QuickMPC/config
      - type: volume
        source: sharedb3
        target: /db/share
      - type: volume
        source: resultdb3
        target: /db/result
    env_file:
      - ../config/computation_container/compute3/.env
      - ../config/computation_container/jwt/client.sample.env
    networks:
      shared-network:
        ipv4_address: 10.0.3.20
    depends_on:
      dev_bts:
        condition: service_healthy
      dev_cc_envoy3:
        condition: service_started
    command: ["/bin/bash", "-c", "printenv && ./computation_container_test"]

  benchmark_cc1:
    container_name: computation_container1
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    volumes:
      - type: bind
        source: ../config/computation_container/compute1
        target: /QuickMPC/config
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    env_file:
      - ../config/computation_container/compute1/.env
      - ../config/computation_container/jwt/client.sample.env
    networks:
      shared-network:
        ipv4_address: 10.0.1.20
    depends_on:
      dev_bts:
        condition: service_healthy
      dev_cc_envoy1:
        condition: service_started
    command:
      ["/bin/bash", "-c", "printenv && ./computation_container_benchmark"]

  benchmark_cc2:
    container_name: computation_container2
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    volumes:
      - type: bind
        source: ../config/computation_container/compute2
        target: /QuickMPC/config
      - type: volume
        source: sharedb2
        target: /db/share
      - type: volume
        source: resultdb2
        target: /db/result
    env_file:
      - ../config/computation_container/compute2/.env
      - ../config/computation_container/jwt/client.sample.env
    networks:
      shared-network:
        ipv4_address: 10.0.2.20
    depends_on:
      dev_bts:
        condition: service_healthy
      dev_cc_envoy2:
        condition: service_started
    command:
      ["/bin/bash", "-c", "printenv && ./computation_container_benchmark"]

  benchmark_cc3:
    tty: true # docker run -t
    container_name: computation_container3
    expose:
      - "51020"
      - "50010"
    image: ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    build:
      context: ../
      dockerfile: packages/server/computation_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-cc:test-cc-medium
    volumes:
      - type: bind
        source: ../config/computation_container/compute3
        target: /QuickMPC/config
      - type: volume
        source: sharedb3
        target: /db/share
      - type: volume
        source: resultdb3
        target: /db/result
    env_file:
      - ../config/computation_container/compute3/.env
      - ../config/computation_container/jwt/client.sample.env
    networks:
      shared-network:
        ipv4_address: 10.0.3.20
    depends_on:
      dev_bts:
        condition: service_healthy
      dev_cc_envoy3:
        condition: service_started
    command:
      ["/bin/bash", "-c", "printenv && ./computation_container_benchmark"]

  medium_mc1:
    container_name: manage_container1
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-medium
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-medium
    volumes:
      - type: bind
        source: ../config/manage_container/manage1
        target: /QuickMPC/config
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    env_file:
      - ../config/manage_container/manage1/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.1.10
    depends_on:
      dev_mc_envoy1:
        condition: service_started
    command:
      ["/bin/bash", "-c", "printenv && go test ./integration_test/... -v -cover"]

  medium_mc2:
    container_name: manage_container2
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-medium
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-medium
    volumes:
      - type: bind
        source: ../config/manage_container/manage2
        target: /QuickMPC/config
      - type: volume
        source: sharedb2
        target: /db/share
      - type: volume
        source: resultdb2
        target: /db/result
    env_file:
      - ../config/manage_container/manage2/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.2.10
    depends_on:
      dev_mc_envoy2:
        condition: service_started
    command:
      ["/bin/bash", "-c", "printenv && go test ./integration_test/... -v -cover"]

  medium_mc3:
    container_name: manage_container3
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-medium
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-medium
    volumes:
      - type: bind
        source: ../config/manage_container/manage3
        target: /QuickMPC/config
      - type: volume
        source: sharedb3
        target: /db/share
      - type: volume
        source: resultdb3
        target: /db/result
    env_file:
      - ../config/manage_container/manage3/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.3.10
    depends_on:
      dev_mc_envoy3:
        condition: service_started
    command:
      ["/bin/bash", "-c", "printenv && go test ./integration_test/... -v -cover"]

  send_share_mc1:
    container_name: manage_container1
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    volumes:
      - type: bind
        source: ../config/manage_container/manage1
        target: /QuickMPC/config
      # 開発環境のフォーマッタを統一
      - type: bind
        source: ../.vscode
        target: /QuickMPC/.vscode
      - type: volume
        source: sharedb1
        target: /db/share
      - type: volume
        source: resultdb1
        target: /db/result
    env_file:
      - ../config/manage_container/manage1/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.1.10
    command: ["/bin/bash", "-c", "printenv && ./manage_container"]
    depends_on:
      dev_mc_envoy1:
        condition: service_started

  send_share_mc2:
    container_name: manage_container2
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    volumes:
      - type: bind
        source: ../config/manage_container/manage2
        target: /QuickMPC/config
      - type: volume
        source: sharedb2
        target: /db/share
      - type: volume
        source: resultdb2
        target: /db/result
    env_file:
      - ../config/manage_container/manage2/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.2.10
    command: ["/bin/bash", "-c", "printenv && ./manage_container"]
    depends_on:
      dev_mc_envoy2:
        condition: service_started

  send_share_mc3:
    container_name: manage_container3
    tty: true # 起動しっぱなし
    image: ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    build:
      context: ../
      dockerfile: packages/server/manage_container/Dockerfile
      target: dev
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-mc:test-mc-dev
    volumes:
      - type: bind
        source: ../config/manage_container/manage3
        target: /QuickMPC/config
      - type: volume
        source: sharedb3
        target: /db/share
      - type: volume
        source: resultdb3
        target: /db/result
    env_file:
      - ../config/manage_container/manage3/.env
    expose:
      - "50011"
      - "51011"
    networks:
      shared-network:
        ipv4_address: 10.0.3.10
    command: ["/bin/bash", "-c", "printenv && ./manage_container"]
    depends_on:
      dev_mc_envoy3:
        condition: service_started

  medium-libc:
    container_name: libclient
    image: ghcr.io/acompany-develop/quickmpc-libc:test-libc-medium
    build:
      context: ../
      dockerfile: scripts/libclient/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-libc:test-libc-medium
    volumes:
      - type: bind
        source: ./libclient/data
        target: /libclient/data
      - type: bind
        source: ./libclient/src
        target: /libclient/src
    command:
      [
        "/bin/bash",
        "-c",
        "pip list && pytest src/tests -s -v -log-cli-level=DEBUG",
      ]
    network_mode: "host"
    depends_on:
      dev_mc1:
        condition: service_healthy
      dev_mc2:
        condition: service_healthy
      dev_mc3:
        condition: service_healthy

  benchmark-libc:
    container_name: libclient
    image: ghcr.io/acompany-develop/quickmpc-libc:test-libc-medium
    build:
      context: ../
      dockerfile: scripts/libclient/Dockerfile
      target: medium
      cache_from:
        - type=registry,ref=ghcr.io/acompany-develop/quickmpc-libc:test-libc-medium
    volumes:
      - type: bind
        source: ./libclient/data
        target: /libclient/data
      - type: bind
        source: ./libclient/src
        target: /libclient/src
    command:
      [
        "/bin/bash",
        "-c",
        "pip list && pytest src/benchmark -s -v -log-cli-level=DEBUG",
      ]
    network_mode: "host"
    depends_on:
      dev_mc1:
        condition: service_healthy
      dev_mc2:
        condition: service_healthy
      dev_mc3:
        condition: service_healthy

volumes:
  sharedb1:
  sharedb2:
  sharedb3:
  resultdb1:
  resultdb2:
  resultdb3:
networks:
  shared-network:
    external: true
