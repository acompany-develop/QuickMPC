inputs:
  ci_package_access_token:
    type: string
    required: true
  ci_remote_cache_json:
    type: string
    required: true
  bazel_cache_bucket:
    type: string
    required: true
  use_cache:
    type: boolean
    default: false
    required: false
  cache_name_suffix:
    type: string
    default: "default"
    required: false

runs:
  using: "composite"
  steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.ci_package_access_token }}

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v2
      with:
        driver-opts: image=moby/buildkit:buildx-stable-1

    - name: Enable buildkit cache
      if: ${{ inputs.use_cache == true }}
      uses: actions/cache@v3
      with:
        path: /tmp/buildkit-cache/buildkit-state.tar
        key: ${{ runner.os }}-buildkit-${{ inputs.cache_name_suffix }}-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-buildkit-${{ inputs.cache_name_suffix }}

    - name: Load buildkit state from cache
      if: ${{ inputs.use_cache == true }}
      uses: magicmemories/gh-action-cache-buildkit-state@a8160e1690b34fa2175ce46e643e955bd15989ce
      with:
        builder: buildx_buildkit_${{ steps.buildx.outputs.name }}0
        cache-path: /tmp/buildkit-cache
        cache-max-size: 2g

    # Setup config for using GCS as bazel remote cache
    - name: Update GCP service account JSON
      shell: bash
      run: echo ${CI_REMOTE_CACHE_JSON} | base64 --decode >> ./src/ComputationContainer/sa.json
      env:
        CI_REMOTE_CACHE_JSON: ${{ inputs.ci_remote_cache_json }}

    - name: Update .bazelrc for using remote cache
      shell: bash
      run: |
        eval "echo \"$(cat ./.github/workflows/.bazelrc_for_ci)\"" >> ./src/ComputationContainer/.bazelrc
      env:
        BAZEL_CACHE_BUCKET: ${{ inputs.bazel_cache_bucket }}
