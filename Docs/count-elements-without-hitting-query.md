# CouchbaseにN1QLでSELECT Count(*) クエリを叩かず要素数を数える

## 背景

Couchbaseで

```sql
SELECT COUNT(*) FROM `bucket`
```

をすると整合性が担保されない。

Couchbaseには整合性レベルというものがあり、現状ではパフォーマンスを犠牲にindexの更新を待機してからクエリを実行して整合性を担保するレベルでクエリを叩いていてこれまで特に問題はなかった。

しかし、ある特殊な環境下でのみ`COUNT(*)`時に整合性が合わない現象がみられた。

なお、現状COUNTを使うシーンがTEST以外ないため影響はほぼない。

とはいえ，COUNTを今後使うシーンがあるかもしれないので，対処法を提案しておく。

## 提案

```
SELECT * FROM `bucket`
```

で全てとってきた上で、結果のlengthをアプリケーション側で取得する

## 理由

上記手法では同様の問題は発生しなかった

## コメント

さまざまな調査をした上で現在も原因は不明
