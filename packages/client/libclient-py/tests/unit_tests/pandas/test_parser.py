import math
import os
from typing import List

import numpy as np
import pytest

from quickmpc.pandas.parser import parse, to_float_for_matching
from quickmpc.proto.common_types.common_types_pb2 import (Schema,
                                                          ShareValueTypeEnum)


def schema_fp(name: str):
    return Schema(name=name,
                  type=ShareValueTypeEnum.SHARE_VALUE_TYPE_FIXED_POINT)


def schema_int(name: str):
    return Schema(name=name,
                  type=ShareValueTypeEnum
                  .SHARE_VALUE_TYPE_UTF_8_INTEGER_REPRESENTATION)


@pytest.mark.parametrize(
    ("data", "expected_secrets", "expected_schema"),
    [
        # é€šå¸¸case
        ([["id", "a", "b"], ["1.0", "0", "0.77"], ["2.0", "0", "0.37"]],
            [[1.0, 0, 0.77], [2.0, 0, 0.37]],
            [schema_fp(name) for name in ["id", "a", "b"]]),
        # tagä»˜ã
        ([["id", "id:id"], ["str", "2.0"]],
            [[7566450, 2.0]],
         [schema_int('id'), schema_fp('id:id')]),

        # edge case
        ([["id", "zero", "int_max", "int_min", "float_min_plus", "float_max_minus", "string_max"],
          ["0", "0", "10000000000", "-10000000000", "0.00000000001", "-0.00000000001", "æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢æ¼¢"]],
         [[0.0, 0.0, 10000000000.0, -10000000000.0, 1e-11, -1e-11,
           int("81294350169683468997949680580862592771577912922072"
               "36632400050104509615137476244113137539228236962890"
               "89905138692745252046833975772231912182206188328210"
               "81279432914839184494239587101708027624541370933123"
               "68149274563052848571173688610270601118642272068865"
               "22496475253062960582977996069853904249160161884498"
               "64934707366850044043560444525534296671882689624558"
               "93378590606524039920506290155528443329249289352988"
               "49760041461604479652281391213810919816909043857787"
               "00510308508878188586225840655663687548627856127039"
               "57175589550585173230207382554871236018828522293673"
               "02126273605394741788903345081386469105599169195819"
               "39468105800193045261057531096900489700577325273207"
               "98536071543866188251271568706724994264407560416453"
               "81217695322382089434035065563991003093904909306125"
               "11163318452529850974389275356346277879041680458316"
               "50090419575989884832360835439272035118836446018413"
               "53766797122424138125999929904309477371555391875492"
               "69608750633258432842250418098579843718735263066494"
               "08295204577015517577504420209608212039463233042776"
               "87236970441330226313049073973193625794797622371727"
               "62599727276958854389544573018690121943895330548409"
               "76582488029804473975132738885979509995431402029338508450")]],
         [schema_fp('id'), schema_fp('zero'), schema_fp('int_max'),
          schema_fp('int_min'), schema_fp('float_min_plus'),
          schema_fp('float_max_minus'), schema_int('string_max'), ]),

        # æ–‡å­—åˆ—
        ([["id", "alphabet", "hiragana", "katakana", "chinese_characters", "large_number", "emoji"],
            ["0", "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ", "ãã‚ãƒã„ã…ã†ã‡ãˆã‰ãŠã‹ãŒããããã‘ã’ã“ã”ã•ã–ã—ã˜ã™ãšã›ãœãããŸã ã¡ã¢ã£ã¤ã¥ã¦ã§ã¨ã©ãªã«ã¬ã­ã®ã¯ã°ã±ã²ã³ã´ãµã¶ã·ã¸ã¹ãºã»ã¼ã½ã¾ã¿ã‚€ã‚ã‚‚ã‚ƒã‚„ã‚…ã‚†ã‚‡ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚ã‚ã‚‘ã‚’ã‚“ã‚”ã‚•ã‚–",
             "ã‚¡ã‚¢ã‚£ã‚¤ã‚¥ã‚¦ã‚§ã‚¨ã‚©ã‚ªã‚«ã‚¬ã‚­ã‚®ã‚¯ã‚°ã‚±ã‚²ã‚³ã‚´ã‚µã‚¶ã‚·ã‚¸ã‚¹ã‚ºã‚»ã‚¼ã‚½ã‚¾ã‚¿ãƒ€ãƒãƒ‚ãƒƒãƒ„ãƒ…ãƒ†ãƒ‡ãƒˆãƒ‰ãƒŠãƒ‹ãƒŒãƒãƒãƒãƒãƒ‘ãƒ’ãƒ“ãƒ”ãƒ•ãƒ–ãƒ—ãƒ˜ãƒ™ãƒšãƒ›ãƒœãƒãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ£ãƒ¤ãƒ¥ãƒ¦ãƒ§ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ®ãƒ¯ãƒ°ãƒ±ãƒ²ãƒ³ãƒ´ãƒµãƒ¶ãƒ·ãƒ¸ãƒ¹ãƒº", "æ˜¥çœ ä¸è¦šæšå‡¦å‡¦èå•¼é³¥å¤œæ¥é¢¨é›¨å£°èŠ±è½çŸ¥å¤šå°‘", "ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™ï¼", "ğŸ˜€ğŸ˜ğŸ˜‚ğŸ¤£ğŸ˜ƒğŸ˜„ğŸ˜…ğŸ˜†ğŸ˜‰ğŸ˜ŠğŸ˜‹ğŸ˜ğŸ˜ğŸ˜˜ğŸ˜—ğŸ˜™ğŸ˜šâ˜ºğŸ™‚ğŸ¤—ğŸ¤©ğŸ¤”ğŸ¤¨ğŸ˜ğŸ˜‘ğŸ˜¶ğŸ™„ğŸ˜ğŸ˜£ğŸ˜¥ğŸ˜®ğŸ¤ğŸ˜¯ğŸ˜ªğŸ˜«ğŸ˜´ğŸ˜ŒğŸ˜›ğŸ˜œğŸ˜ğŸ¤¤ğŸ˜’ğŸ˜“ğŸ˜”ğŸ˜•ğŸ™ƒğŸ¤‘ğŸ˜²â˜¹ğŸ™ğŸ˜–ğŸ˜ğŸ˜ŸğŸ˜¤ğŸ˜¢ğŸ˜­ğŸ˜¦ğŸ˜§ğŸ˜¨ğŸ˜©ğŸ¤¯ğŸ˜¬ğŸ˜°ğŸ˜±ğŸ˜³ğŸ¤ªğŸ˜µğŸ˜¡ğŸ˜ ğŸ¤¬ğŸ˜·ğŸ¤’ğŸ¤•ğŸ¤¢ğŸ¤®ğŸ¤§ğŸ˜‡ğŸ¤ ğŸ¤¡ğŸ¤¥ğŸ¤«ğŸ¤­ğŸ§ğŸ¤“"]],
         [[0.0,
           int("64376492020959182960102910068921920137578270955447"
               "00994229324997296606723909755334743502970718979797"
               "0623272423014052591589722"),
           int("18821911475279072699387439378566387956111513430849"
               "98741952969572035357165535685798000133453408036689"
               "60160103388093358070845619527428351083947816319970"
               "68197752686532392007825472475930054751868291136212"
               "77019627540944278401988123354850270368777761874656"
               "45316362109187736348507908126831678265681238598501"
               "23577310226349872232686643901854391335408463304253"
               "01682911916053212936940769061936237574578117604085"
               "88352253853016582783122458127379747103590307703326"
               "57151190966625605364130654678784763647229799193680"
               "09523441872290151221507683287637256104630532783466"
               "58111173391924857763294806692219085593993637534359"
               "1571891468414377755286"),
           int("14912542658855752609410365103382549324896634886740"
               "87676470590141269487934510022829817548299216842792"
               "98438903311001642333143441433438704924300538949095"
               "32942191147182049154933726045184579039893027681132"
               "56355932385594038940420768768484463399674315383985"
               "47301138620521332048182374493629643773074940611526"
               "75879512118388895164305703580504060293022378036614"
               "66495841636938406245380426862623189171317152868783"
               "70613211773451673474674673254532557304972825179677"
               "97812813079538349280461257033910282465046779757529"
               "81254609824400360070011263743009764449856399529757"
               "60824439920591075847525994360947110332554548784783"
               "796109833618687851418330161690984711082784722224058"),
           int("28119672167872720019552145190445826596296897272947"
               "03346740607363576652787689147056884078078276981761"
               "405396389018008701107809927286173590891114641"),
           1234567890,
           int("211468821694167298822425608026642389526422768034683"
               "117887523299027367063178633447218214806099172321322"
               "288173666141875761397035971008732406120200818109267"
               "393120314332696034980323839007698473067364671688607"
               "991072751230542256515932664815172859924656913027635"
               "244933222746944965021341538394490540746131875212981"
               "594004537530310958198451743439788965233803503650396"
               "909643490325355499714623883988847749551526638862617"
               "511498104555793375641187986020914972865481939495752"
               "666170283454386182839015588954916038595103239809564"
               "292612950925652856028665584158812549814716176516384"
               "302944977554669470725218119056419168414907550419367"
               "034752374720673861071802168371926464783306451316474"
               "812456231861899345847835409249452197186218746747171"
               "844751603308718642452247128051867710116400212514281"
               "0930019243580675071649756234712858207379"),
           ]],
         [
             schema_fp('id'), schema_int('alphabet'), schema_int('hiragana'),
             schema_int('katakana'), schema_int('chinese_characters'),
             schema_fp('large_number'),  # TODO: æ–‡å­—åˆ—ã¨ã—ã¦è§£é‡ˆã—ã¦ã»ã—ã„
             schema_int('emoji'),
        ]),
    ]
)
def test_parse(data, expected_secrets, expected_schema):
    secrets, schema = parse(data)
    for row, row_expected in zip(secrets, expected_secrets):
        for x, y in zip(row, row_expected):
            if type(x) == int:
                assert x == y
            else:
                assert math.isclose(x, y)
    assert (schema == expected_schema)


@pytest.mark.parametrize(
    ("data", "expected_exception"),
    [
        # è¡ŒãŒè¶³ã‚Šãšã‚·ã‚§ã‚¢ãŒãªã„
        ([["id", "a", "b", "c"]], RuntimeError),
        # schemaã«åŒã˜ã‚‚ã®ãŒå«ã¾ã‚Œã‚‹
        ([["id", "a", "a"],
          ["id1", "1", "2"],
          ["id2", "3", "4"]], RuntimeError),
        # æ­£æ–¹è¡Œåˆ—ã§ãªã„
        ([["id", "a", "b"],
          ["id1", "1", "2"],
          ["id2", "3", "4", "5"]], RuntimeError),
        ([["id", "a", "b"],
          ["id1", "1", "2"],
          ["id2"]], RuntimeError),
        # tableãŒç©º
        ([["id"]], RuntimeError),
        # csvå½¢å¼ã§ãªã„
        ({"name": "I am json"}, KeyError),
    ]

)
def test_parse_errorhandring(data, expected_exception):
    """ ç•°å¸¸å€¤ã‚’ä¸ãˆã¦ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‹Test """
    with pytest.raises(expected_exception):
        parse(data)


@pytest.mark.parametrize(
    ("val", "expected"),
    [
        # æ–‡å­—åˆ—
        ("id1", 125382372.3739109),
        ("hogehuga@gmail.com", 86705962.83638954),
        ("very_very_very_very_very_very_very_very_very_long_string", 190655731.5899248),
        ("æ—¥æœ¬èªã®æ–‡å­—åˆ—ãƒ‡ã‚¹ãƒ¨", 40972936.22852039),
        ("â—ï¸âœ¨ğŸ¤ŸğŸ˜ğŸ‘æ„Ÿè¬â—ï¸ğŸ™Œâœ¨æ„Ÿè¬â—ï¸ğŸ™Œâœ¨â—ï¸ğŸ–ğŸ˜‹ğŸ´âœ¨", 62936327.66452408),
        ("", 217595411.34348965),
        # æ•°å€¤
        (0, 52152834.036356926),
        (1, 81786090.20335388),
        (1000000000000000000000, 35709723.87166405),
        (1.1, 199269155.31771374),
        (1000000000000000000000.11111111111111111111, 19815069.039226532),
    ]
)
def test_to_float_for_maching(val, expected):
    assert math.isclose(to_float_for_matching(val), expected)
